---
title: 设备管理
categories: study
tags : 操作系统复习
toc: true
---
在一个计算机系统中，除了需要直接用于I/O和存储信息的设备外，还需要有相应的设备控制器，在大、中型计算机系统中，还要有I/O通道，由这些设备和相应的总线构成了I/O系统。
# I/O系统的结构
- (1)微机I/O系统：总线结构。
- (2)主机I/O系统：四级结构(主机、通道、控制器、设备)
![微机](https://img-blog.csdnimg.cn/20200611170332903.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MzQxOTE0,size_16,color_FFFFFF,t_70)![主机](https://img-blog.csdnimg.cn/20200611170405486.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MzQxOTE0,size_16,color_FFFFFF,t_70)
# I/O设备的分类
(1)按传输的速率分类
  - 低速设备：键盘鼠标，几个字节-几百字节/秒
  - 中速设备：打印机，数千~数十千字节/秒
  - 高速设备：磁带机、磁盘机、光盘机 几十万~几兆/秒
(2)按信息交换的单位分类
  -  块设备：数据的存取以数据块为单位，如磁盘。块设备在块中保存信息，块的大小通常是固定的，并且一次只传送一块，通常可以通过块号访问数据。
  -  字符设备：传送字节流，没有使用块结构。终端、打印机、通信端口、鼠标等都是字符设备。
(3)按设备的共享属性分类
  - 独占设备
  - 共享设备
  - 虚拟设备

# 设备控制器
  设备控制器的定义
   - ①设备控制器是CPU与I/O设备之间的接口，接受I/O的命令并控制I/O设备完成工作。
   - ②设备控制器是一个可编址设备：连接多个设备时可有多个设备地址
## 设备控制器的功能
- 接收和识别命令
- 数据交换
- 设备状态的了解和报告
- 地址识别
- 数据缓冲
- 差错控制
## 设备控制器的组成
- 设备控制器与处理机的接口
- 设备控制器与设备的接口
数据信号：控制器→设备；或设备→控制器。
控制信号：控制器→设备；用于规定设备执行读或写操作的信号。
状态信号：用于指示设备的当前状态
![-](https://img-blog.csdnimg.cn/20200611170825920.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MzQxOTE0,size_16,color_FFFFFF,t_70)
I/O逻辑用来译码 
# I/O通道
# I/O控制方式
程序I/O方式；
     ↓
中断驱动方式；
     ↓
DMA控制器，使传输以字节为单位变成以数据块为单位。
     ↓
    通道。使I/O的组织和数据的传送，都能独立进行，无需cpu控制
## 轮询控制方式
主机在试图发送I/O控制命令之前先反复检测设备控制器状态寄存器的忙/闲标志位，若设备忙，则主机继续检测该标志位，直到该标志位为“空闲”，然后发送I/O指令。

## 中断控制方式
进程执行                                                                
  …                                       
 发I/O请求
  ↓                                         
转入睡眠（阻塞）              
         ↓                                  
CPU调度新的进程来投入运行          
        ↓ 
 I/O完毕CPU收到中断，处理中断将数据接收    
      ↓ 
使发出I/O请求的进程就绪
        ↓   
 调度一个进程执行
        …
与轮询控制方式相比，中断驱动I/O控制方式可以极大地提高cpu的利用率。
但对于大数据，分为小数据传送，中断太多次会占用cpu太多时间
## DMA控制方式
### DMA控制器的组成
- 命令/状态寄存器
- 内存地址寄存器MAR
- 数据寄存器DR
- 数据计数器DC
没有使用DMA时磁盘读数的过程
- ①首先控制器一个比特一个比特地从设备完整地读出一块数据放入内部缓冲区中。
-  ②计算该块数据的检验和以保证读取正确。
- ③控制器发中断信号，CPU开始一个字节一个字节从控制器的设备寄存器中将数据读入内存。
在这种方式下,每传送一个或多个字节,CPU就要处理一次中断,把数据从控制器的数据缓存送入内存
 DMA方式![在这里插入图片描述](https://img-blog.csdnimg.cn/20200611180235379.png)

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200611180831255.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MzQxOTE0,size_16,color_FFFFFF,t_70)

# 缓冲管理
在数据到达和数据离去的速度不一致的地方都可以引入缓冲
(1)处理数据流的生产者与消费者之间的速度差异
(2)协调传输数据大小不一致的设备
单缓冲
双缓冲
缓冲池
# 设备分配
## 设备分配中的数据结构
  (1)设备控制表 DCT
	   ①设备类型
	   ②设备标识符
	   ③设备状态：等待/不等待，忙 、闲
	   ④指向控制器表的指针
	   ⑤重复执行的次数或时间 
	   ⑥设备队列的队首指针 
  (2)控制器控制表COCT
  ①控制器标示符
   ②控制器状态
   ③与控制器相连接的通道表指针
   ④控制器队列的队首指针
   ⑤控制器队列的队尾指针

  (3)通道控制表CHCT
  ①通道标示符
   ②通道状态
   ③与通道连接的控制器表首址
   ④通道队列的队首指针
   ⑤通道队列的队尾指针

  (4)系统设备表SDT
  每个设备记录一条表项记录设备类型，DCT设备控制表，驱动程序入口
  逻辑设备表LUT可与DCT合并
## 设备分配时应考虑的若干因素
  (1)设备的固有属性
   ①独占设备
   ②共享设备
   ③虚拟设备
  (2)设备分配算法
   ①先来先服务
   ②优先级高者优先
  (3)设备分配中的安全性
   ①安全分配方式  不会导致进程死锁
   ②不安全分配方式
## 设备独立性
设备独立性也称设备无关性，其基本含义是：应用程序独立于具体使用的物理设备。
### 实现设备独立性后可以带来的好处：
- 设备的使用更方便
- 用户程序与物理的外围设备无关，系统增减或变更外- 围设备时不需要修改应用程序。
- 易于处理输入输出设备的故障
  设备独立软件
     设备独立软件的功能：
  ①执行所有设备的公有操作：（独占设备的分配与回收、将逻辑设备名映射为物理设备名、对设备进行保护、缓冲管理、差错控制）
  ②向用户层（或文件层）软件提供统一的接口。
      （如：对各种设备的读操作在应用程序中都使用read）
### 独占设备的分配程序
   对于具有I/O通道的系统，在进程提出I/O请求后，系统的
 设备分配程序可按下述步骤进行设备分配：
  (1)分配设备
  (2)分配控制器
  (3)分配通道
### SPOOLing技术
#### SPOOLing的概念
在多道程序环境下，利用一道程序来模拟脱机输入时的外围控制机的功能，把低速I/O设备上的数据传送到高速磁盘上；再利用另一道程序来模拟脱机输出时外围控制机的功能，把数据从磁盘传送到低速输出设备上。这 种在联机情况下实现的同时外围操作称为Spooling (Simultaneous Periheral Operations On-Line)。
#### SPOOLing系统的组成
   ①输入井和输出井。 (外存)
   ②输入缓冲区和输出缓冲区
   ③输入进程spi和输出进程spo 
   ④请求I/O队列
 ![在这里插入图片描述](https://img-blog.csdnimg.cn/20200611231328195.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MzQxOTE0,size_16,color_FFFFFF,t_70)
#### 利用SPOOLing技术实现共享打印机
当用户进程提出打印请求时，spooling系统先为用户做两件事：第一步：由输出进程在输出井中为之申请一空闲盘块区，并将要打印的数据送入其中。
第二步：输出进程再为用户申请、并填写一张用户请求打印表，将该表挂到请求打印队列上。当打印机空闲时，输出进程完成以下动作。
①从请求打印队列队首取一张请求打印表。
②将打印数据从输出井送打印机缓冲区(输出缓冲区)。
③打印。
④若打印完转第①步，取下一个打印请求表。
#### SPOOLing的特点
   ①提高I/O速度
   ②将独占设备改造为共享设备
   ③实现了虚拟设备功能
# 设备管理软件的层次结构
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200611232106331.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MzQxOTE0,size_16,color_FFFFFF,t_70)

> I/O中断处理程序的作用是将发出I/O请求而被阻塞的进 程唤醒
## 设备驱动程序
设备驱动程序是I/O进程与设备控制器之间的通信程序。其主要任务是接收上层软件发来的抽象要求，再把它转换成具体要求后发送给设备控制器，启动设备去执行，此外，它也将由设备控制器发来的信号传送给上层软件。设备驱动程序中包括了所有与设备相关的代码,是数据结构与函数的集合。每个设备驱动程序只处理一种设备，或者一类紧密相关的设备。只有驱动程序才知道某类设备控制器有多少个寄存器及它们的用途。
与硬件无关的I/O软件
设备无关I/O软件的功能：
    ①设备命名：将设备名映射到相应的驱动程序
    ②设备保护：为设备设置合理的访问权限
    ③提供一个独立于设备的块大小
    ④块设备和字符设备都需要缓冲技术
    ⑤块设备的存储分配
    ⑥分配和释放独立设备
    ⑦错误处理 
### 磁盘驱动程序
当有一个读第N块磁盘的请求时，磁盘驱动程序要完成以下的工作：
     ①计算出所请求块的物理地址。
     ②检查驱动器电机是否在运转。
     ③检查磁头臂是否定位在正确的柱面。
     ④确定需要哪些控制器命令及命令的执行次序。
     ⑤向设备控制器的设备控制寄存器中写入命令。
     ⑥阻塞等待，I/O完成后向上层软件传送数据
# 磁盘
## 磁盘结构
物理结构
  扇区，盘面，柱面
逻辑结构
  逻辑块
## 磁盘的类型
   ①固定头磁盘
   ②移动头磁盘
## 磁盘访问时间
   ①寻道时间Ts
   ②旋转延迟时间Tr
   ③传输时间Tt
## 磁盘调度
磁盘调度算法用来从磁盘请求队列中选择一个当前访问磁盘的任务
### FCFS调度
①算法线请求先服务
 ②优点：公平
③缺点：难以保证速度
### SSTF调度--最短寻道时间优先调度算法
①算法：调度程序选择的进程是其要求访问的磁道离当前磁头所在的磁道最近的。
②优点：每次寻道时间最短
③缺点：有些请求可能永远得不到服务，出现“饥饿”
### SCAN—扫描(电梯)算法
①算法：磁臂从磁盘的一端向另一端移动，同时当磁头移过每个柱面时，处理位于该柱面上的请求,当磁头到达另一端时，磁头改变移动方向，继续处理，磁头在磁盘上来回扫描。
 ②优点：不存在饥饿问题。
 ③缺点：某些进程等待时间可能会很长，还可能出现磁  臂黏着。
### C-SCAN—循环扫描算法
①算法：磁臂从磁盘的一端向另一端移动，同时当磁头移过每个柱面时，处理位于该柱面上的请求，当磁头移到另一端时，立即返回到磁盘开始处，返回时不处理请求。
②优点：减少了 scan算法中某些进程的时间延迟。
③缺点：可能出现磁臂“粘着”。
④解决：采用N-Step-Scan算法或FScan算法

### NStepSCAN和FSCAN算法

***磁盘黏着问题***
## 提高磁盘I/O速度的其他方法
  (1)提前读
  (2)延迟写
  (3)优化物理块的布局
  (4)虚拟磁盘

