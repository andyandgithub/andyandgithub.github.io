---
title: 虚拟内存管理
categories: study
tags : 操作系统复习
toc: true
---
# 虚拟存储器概述
虚拟存储器是指具有***请求调入功能***和***置换功能***，能从逻辑上对内存容量进行扩充的一种存储器系统。在虚拟存储器系统中，进程无需全部装入，只要装入一部分就可运行
## 为什么引入虚拟存储技术
1.提高内存利用率
2.提高多道程序度
3.使程序员不用担心物理内存的容量对编程的限制。
引入虚拟存储的理论依据-**局部性原理** 
## 特征
- 离散性  进程在内存中不连续存储
- 多次性  进程运行时分多次调入内存的
- 对换性  
- 虚拟性
# 虚拟存储器的实现方式
## 请求分页系统
请求分页系统是在分页系统的基础上，增加了请求调页功能、页面置换功能所形成的页式虚拟存储系统。包括：
           1. 请求分页的页表机制
           2. 缺页中断机构
           3. 地址变换机构
### 页表
页表项包括以下内容：
- 1.物理块号：页在物理内存中的物理块编号。
- 2.状态位P：用来标识页是否在内存中。例如可以规定P为0时表示页不在内存中，需要请求调页，缺页中断处理。P为1时表示页在内存。
- 3.访问字段A：用于记录页最近被访问的情况。A中可以存放页最近被访问的次数，也可以存放最近未被访问的时间长度。也可以简单地用 A=1表示页最近被访问过，用A=0表示页最近没有被访问	过。操作系统实现置换程序时需要根据A的值来选择被换出的页，出于效率的考虑，系统总是希望根据A的值把最近最久未访问的页换出到外存。
-  4.修改位M：用于标识页最近是否被修改过。由于内存中的每个页在外存中都保存有一个副本，如果页没有被修改过，则外存中的页副本和内存中的页完全一致，因此，换出页时就不用把页的信息写回外存，只需要把该页所占用的物理块标识为空闲可用。如果页最近被修改过，那么内存中的页和外存中该页的副本就不一致，在换出页时，必须把最近修改过的页写回外存。往外存中写信息，需要请求磁盘操作，为了减少系统开销和启动磁盘的次数，在进行页置换时，尽量选择最近没有被修改过的页面。
- 5.外存地址：用于指出页面在外存中的地址。页表中不给，通过页号的一定映射关系找到。	
### 缺页中断机构
   1.在指令执行期间产生中断
   2.回到中断前的指令处重新执行被中断的指令 
### 地址变换   
1. 根据逻辑地址中的页号查找快表。
2. 若快表中无该页信息，转到内存页表中查找。
3. 若页表中的状态P显示该页已调入内存，则将该表项写 入快表，并计算物理地址。
4. 若该页尚未调入内存、则产生缺页中断，请求OS从外存中把该页调入内存并写入快表
![](https://img-blog.csdnimg.cn/20200611130119394.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MzQxOTE0,size_16,color_FFFFFF,t_70) 
### 页面分配
#### 最小物理块数
保证进程正常运行所需要的最少物理块数，它与计算机的硬件结构有关，取决于指令的格式、功能和寻址方式
#### 页面分配和置换策略
##### 固定分配局部置换
系统为每个进程分配**一定数量**的物理块，在进程运行期间，进程拥有的物理块数不再改变。当进程发生缺页时，系统从**该进程**在内存中的页面中选择一页换出，然后再调入请求的页面，以保证分配给该进程的内存空间保持不变。

##### 可变分配全局置换
这是在操作系统中被广泛使用的策略。在采用这种策略时，先为系统中的每个进程分配一定数量的物理块，同时，操作系统保持一个空闲物理块队列。当某进程发生缺页时，由系统从空闲物理块队列中取出一个物理块分配给该进程，并将欲调入的缺页装入其中。任何产生缺页的进程都可以由系统获得新的物理块，以增加本进程在物理内存中页的数量。当系统总空闲物理块数小于一个规定的**阈值**时，操作系统会从内存中选择一些页调出，以增加系统的空闲物理块数，调出的页可能是系统中**任何**一个进程的页
##### 可变分配局部置换 
系统为进程分配一定数目的物理块，当进程发生缺页时，只允许从该进程在内存中的页中选出一页换出，只有当进程频繁发生缺页时，操作系统才会为该进程追加物理块，以装入更多的进程页，直到该进程的缺页率降低到适当程度。反之，若一个进程在运行过程中的缺页率特别低，则可在不引起进程缺页率明显增加的前提下适当减少分配给该进程的物理块数
#### 分配算法
  1. 平均分配算法
  2. 按比例分配算法  
  3. 考虑优先权的分配算法
#### 何时调入页面
  1.预调页策略：将预计不久之后会被访问的页，预先调入内存。                
  2.请求调页策略： 缺那页调那页
#### 从何处调入页面
- 1.对换区调入：对换空间足够大,进程运行前,将相关文件从文件区拷贝到对换区，发生缺页请求时，从对换区调入缺页。对换区比文件区较快。
- 2.从文件区调入：对不会修改的页，从文件区调入；可能被修改的部分，换出时写入对换区，再换入时，从对换区调入。
- 3.Unix方式:与进程有关的文件都放在文件区,凡是未运行过的页面都应该从文件区调入,曾经运行过又被换出的页面从对换区调入 

### 页面置换算法
选择淘汰页的算法
当内存中空闲物理块少于某个值时，执行淘汰页算法

#### 最佳置换算法
  1. 策略：将未来最长时间内不再被访问的页换出。
  2. 缺点：不可实现。
  3. 优点：换页率最低
#### 先进先出页面置换
  1. 策略：最先进入内存的页最先被淘汰。
  2. 实现：采用一个先进先出队列。
  3. 缺点：无法保证常用页面不被换出，导致较低的效率。
  4. 优点：实现简单。
#### 最近最久未使用（Least Recently Used）LRU置换算法
LRU置换算法是选择最近最久未使用的页面予以淘汰
##### 实现
1. 栈
可利用一个特殊的栈来保存当前使用的各个页面的页面号。每当进程访问某页面时，便将该页面的页面号从栈中移出，将它压入栈顶。因此，栈顶始终是最新被访问页面的编号，而栈底则是最近最久未使用的页面号
2. 时间计数器
每个页表项增加一个时间字段，并为CPU增加一个逻辑时钟或计数器。每次访问内存某个页时，就将递增了的时钟寄存器的值赋给这个页对应的页表项的时间字段，每次置换时选择时间字段值最小的页作为换出页面
#### LRU的近似算法
#####  附加引用位算法
为内存的页保留一个8位的字节，在规定时间间隔内，操作系统把每个页的引用位（也就是访问位A）转移到其8bit字节的高位，将其他位右移，并抛弃最低位。置换时选附加位值最小的页面。 
##### 简单的Clock置换算法
利用Clock算法时，为每一页设置一位访问位，再将内存中的所有页都通过链接指针链接成一个循环队列。当某页被访问时，其访问位被置1。置换算法在选择一页淘汰时，只需检查其访问位。如果是0，就选择该页换出；若为1，则重新将它复0，暂不换出而给该页第二次驻留内存的机会，再按照FIFO算法检查下一个页面。
    当检查到队列中的最后一个页时 ，若其访问位仍为1，则返回到队首再去检查第一个页。
##### 改进型Clock置换算法
 在将一个页换出时，如果该页已被修改过，便须将它重新写到磁盘上，但如果该页未被修改过，则不必将它写回磁盘。换言之，对于修改过的页在换出时所付出的开销将比未修改过的页开销大。在改进型Clock算法中，除考虑页的使用情况外，还须再增加一个置换代价这一因素。这样，选择换出页时，既要是未使用过的页，又要是未被修改过的页。把同时满足两个条件的页作为首选的淘汰页
步骤
1、从指针所指示的当前位置开始，扫描循环队列，寻找A=0且M=0的第一类页。将遇到的第一个页作为所选中的淘汰页。在第一次扫描期间不改变访问位A。
2、如果第一步失败，则开始第二论扫描，寻找A=0且M=1的第二类页面，将所遇到的第一个这类页面作为淘汰页。在第二轮扫描期间，将所有经过的页面的访问位置0。
3、如果第二步也失败，即未找到第二类页面，则将指针返回到开始的位置。然后，重复第一步，如果仍失败再重复第二步，此时一定能找到被淘汰的页。
#### 最少使用置换算法
该置换算法选择在最近时期使用最少的页面作为淘汰页。 
#### 页面缓冲算法
采用可变分配和局部置换方式，置换算法采用的是FIFO。算法规定如果被淘汰的页面未被修改，就将它直接放入空闲链表中，否则，便放入已修改页面的链表中。 
### 性能分析
1. 有效访问时间：成功访存所用的时间。
 2. P：缺页率。
Ma：内存访问时间
有效访问时间=(1-P)×ma+P×缺页中断时间。
缺页中断时间=缺页中断服务时间+缺页读入时间+进程重新执行时间
#### 工作集

在某段时间间隔△里，进程实际要访问的页的集合。要使缺页少发生，必须使程序的工作集全部在内存中。
W(t, △) 工作集的窗口
△又叫工作集的“窗口尺寸”， △太大，影响存储器利用率。
△太小，缺页率高，降低系统吞吐量。
W(t，△)与t相关，不同的t对应不同的工作集。
即：程序运行的过程中，运行到不同的时刻，需要访问的页不同。 
#### Windows NT的页面分配策略
1、 采用请求调页
2、进程被第一次创建时，为进程指定了一个最小工作集和一个最大工作集。最小工作集，是进程正常运行需要调入内存的最小页数。当内存有足够的空间时，可以为进程分配足够的空间以装入它的最大工作集。
3、 当某进程在内存中的页数<最大工作集时，若发生缺页，系统从空闲页框队列中取一空页框分配给该进程。当某进程在内存中的页数=最大工作集时，若发生缺页，系统从该进程的页面中按FIFO的原则，淘汰一个该进程的页。
4、当空白的页框队列中空闲页框的数量减到一个最低值时，系统检查所有进程，对工作集>最小工作集的进程，淘汰该进程的一些页，使该进程的工作集=最小工作集。 

### 抖动
多道程序度太高，使运行进程的大部分时间都用于进行页的换入/换出，而几乎不能完成任何有效的工作的状态称为“抖动”
#### 抖动的预防
1、采取局部置换策略。当进程发现缺页后，仅在自己的内存空间范围内置换页面，不允许从其他进程获得新的物理块。
2、在CPU调度程序中引入工作集算法。只有当每个进程在内存中都有足够大的驻留集时，方能再从外存上调入新的作业。
3、L=S准则。调整多道程序度，以使产生缺页的平均时间L=系统处理缺页的平均时间S。
4、挂起若干进程。为了预防抖动，挂起若干进程，腾出进程占用的空间。 

### 页置换率 
## 请求分段系统
请求分段系统是在分段系统的基础上，增加了请求调段及分段置换功能后所形成的段式虚拟存储系统。
   1. 请求分段的段表机制
   2. 缺段中断机构
   3. 地址变换机构 

