---
layout: post
title: react实战
categories: study
tags : Javascript
toc: true

---



# question
setState频繁使用，无限循环
## 按需引入

- 安装依赖

```Shell
yarn add craco craco-less babel-plugin-import
```

- 复制代码 因为antd是用less写的所以需要craco-less这个包来编译less文件 详细配置 修改启动脚本package.json

```json



"scripts": {
"start": "craco start",
"build": "craco build",
"test": "craco test"
}.
```

创建文件craco.config.js

```js


const CracoLessPlugin = require('craco-less')

module.exports = {
    plugins: [
        {
// 使用CracoLessPlugin自定义主题颜色
            plugin: CracoLessPlugin,
            options: {
                lessLoaderOptions: {
                    lessOptions: {
// 自定义less变量
                        modifyVars: {
                            '@primary-color': '#282c34', // 蓝黑色
                            '@success-color': '#5ecdc4', // 湖绿色
                            '@warning-color': '#6d4cc2', // 紫色
                            '@error-color': '#e64a19', // git桔色
                        },
                        javascriptEnabled: true, // 允许使用js修改less文件，必须为true，否则无法生效
                    },
                },
            },
        },
    ],
// 配置babel-plugin-import按需引用
    babel: {
        plugins: [
            [
                'import',
                {
                    libraryName: 'antd',
                    libraryDirectory: 'es',
                    style: true,
                },
            ],
        ],
    },
}
```

修改 src/App.jsx 添加`import './App.less' import { Row, Col, PageHeader, Card, Avatar, Button, Radio } from 'antd'`

`import './App.less' `创建less文件 src/App.less 
`@import '~antd/dist/antd.less';`



## form 表单的验证

### 声明式表单验证，自定义表单验证分别验证
username采用的是分别验证
passward采用的是函数validator验证
```js
import './login.less'
import logo from './images/logo.jpg'
import { Form, Input, Button, Checkbox } from 'antd';
import { UserOutlined, LockOutlined } from '@ant-design/icons';

export default function Login(){
    function onFinish(values){
        console.log('Received values of form: ', values);
    }
    function validatePwd(rules,value){
        if(!value){
            // callback("密码必须输入")
            return Promise.reject("密码必须输入")
        }else if(value.length<4){
            // callback("密码必须大于四位")
            return Promise.reject("密码必须大于四位")
        }else if(value.length>12){
            // callback('密码必须小于12位')
            return Promise.reject("密码必须小于12位")
        }else if(!(/^[a-zA-Z0-9]+$/.test(value))){
            // callback("只能包括字母数字以及下划线")
            return Promise.reject("只能包括字母数字以及下划线")
        }
        return  Promise.resolve();
    }
    return (
        <div className="login">
            <header className="loginHeader">
                <img src={logo} alt="logo"/>
                <h1>React项目 后台管理平台</h1>
            </header>
            <section className="loginSection">
                <h2>用户登录</h2>
                <Form
                    name="normal_login"
                    className="loginForm"
                    initialValues={{ remember: true }}
                    onFinish={onFinish}
                >
                    <Form.Item
                        name="username"
                        rules={[
                            { required: true, message: '请输入用户名' },
                            { min: 4, message: '至少输入4位' },
                            { max: 12, message: '最多12位' },
                            { pattern: /^[a-zA-Z0-9]+$/, message: '只能包括字母数字以及下划线' },
                        ]}
                    >
                        <Input prefix={<UserOutlined className="site-form-item-icon" />} placeholder="用户名" />
                    </Form.Item>
                    <Form.Item
                        name="password"
                        rules={[
                            { required: true, whitespace:true,message: '输入密码' },
                            // { min: 4, message: '至少输入4位' },
                            // { max: 12, message: '最多12位' },
                            // { pattern: /^[a-zA-Z0-9]+$/, message: '只能包括字母数字以及下划线' },
                            {validator:validatePwd}
                        ]}
                    >
                        <Input
                            prefix={<LockOutlined className="site-form-item-icon" />}
                            type="password"
                            placeholder="密码"
                        />
                    </Form.Item>
                    <Form.Item>
                        <Button className="loginFormButton" type="primary" htmlType="submit" >
                            登陆
                        </Button>
                    </Form.Item>
                </Form>
            </section>
        </div>
    )
}


```
### 点击提交是统一验证
通常用于发送ajax请求后端验证

绑定表单使用`const[form]=useForm();`
表单里`from={form}`
form.function调取相应的实例方法`from.validateFields().then(()=>{})·
或者使用ref
`const f1=useRef();`
表单中`ref={f1}`
`f1.current.validateFields().then(()=>{})`
```js
import './login.less'
import logo from './images/logo.jpg'
import { Form, Input, Button, Checkbox } from 'antd';
import { UserOutlined, LockOutlined } from '@ant-design/icons';

import {useRef} from 'react'

export default function Login(){
    const [form] = Form.useForm();
    const f1=useRef("loginForm")
    console.log("formFrom",form)

    console.log("useref",f1)
    // f1.loginFrom.

    // f1.validateFields
    function onFinish(values){

        console.log('Received values of form: ', values);
        f1.current.validateFields().then((values)=>{
            console.log("validateFields",values)
        })

    }
    function validatePwd(rules,value){
        // console.log("validatePwd",rules,value)
        if(!value){
            // callback("")
            return Promise.reject("密码必须输入")
        }else if(value.length<4){
            // callback("密码必须大于四位")
            return Promise.reject("密码必须大于四位")
        }else if(value.length>12){
            // callback('密码必须小于12位')
            return Promise.reject("密码必须小于12位")
        }else if(!(/^[a-zA-Z0-9]+$/.test(value))){
            // callback("只能包括字母数字以及下划线")
            return Promise.reject("只能包括字母数字以及下划线")

        }
        return  Promise.resolve();
    }
    function onFinishFailed(){
        console.log("onfinishfailed")
    }

    return (
        <div className="login">
            <header className="loginHeader">
                <img src={logo} alt="logo"/>
                <h1>React项目 后台管理平台</h1>
            </header>
            <section className="loginSection">
                <h2>用户登录</h2>
                <Form
                    name="normal_login"
                    className="loginForm"
                    initialValues={{ remember: true }}
                    onFinish={onFinish}
                    form={form}
                    ref={f1}
 
                >
                    <Form.Item
                        name="username"
                        // rules={[
                        //     { required: true, message: '请输入用户名' },
                        //     { min: 4, message: '至少输入4位' },
                        //     { max: 12, message: '最多12位' },
                        //     { pattern: /^[a-zA-Z0-9]+$/, message: '只能包括字母数字以及下划线' },
                        //
                        //
                        // ]}
                    >
                        <Input prefix={<UserOutlined className="site-form-item-icon" />} placeholder="用户名" />
                    </Form.Item>
                    <Form.Item
                        name="password"
                        rules={[
                            { required: true, whitespace:true,message: '输入密码' },
                        ]}
                    >
                        <Input
                            prefix={<LockOutlined className="site-form-item-icon" />}
                            type="password"
                            placeholder="密码"
                        />
                    </Form.Item>
                    <Form.Item>
                        <Button className="loginFormButton" type="primary" htmlType="submit" >
                            登陆
                        </Button>
                    </Form.Item>
                </Form>
            </section>
        </div>
    )
}
```
## 发送请求
npm install axios
```js
import axios from 'axios'
import {message} from 'antd'
export default function ajax(url,data={},type="GET"){
    return new Promise((resolve,reject)=>{
        let promise;
        if(type==="GET"){
            promise=axios.get(url,
                {params: data})
        }else if(type==="POST"){
            promise=axios.post(url,data
            )
        }
        promise.then(response=>{
            message.success("ajax请求成功"+response.data)
            resolve(response.data)
        }).catch(error=>{
            message.error("ajax请求失败"+error.message)
        })
    })

}
```
```js
'
const base=""//"lovalhost:5000"
//根据接口文档写接口请求函数
export function reqLogin(username,password){
    return ajax(base+"/login",{username,password},"POST")//.then()

}
```

```js
 function onFinish(values){
        form.validateFields()
            .then( async (values) => {
                    const result =await reqLogin(values.username,values.password)
                    if(result.status){
                        message.error("登陆失败"+result.message)
                    }else{
                        message.success("登录成功"+result.message)
                        memoryUtils.user=result.data
                        storageUtils.saveUser(memoryUtils.user)
                        message.info("user保持成功",memoryUtils.user)
                    }
                    navigate('/admin')
            })
            .catch(errorInfo => {
                console.log("校验失败",errorInfo)
            });
        // navigate('/admin')
    }

```
## 用户变量本地存储

引入`store.js`库
npm install store
```js
import store from 'store'
const USER_KEY="user_key"
export default {
    saveUser(user){
        // alert("localstorage"+JSON.stringify(users))
        // localStorage.setItem(USER_KEY,JSON.stringify(users))
        store.set(USER_KEY,user)
    },
    getUser(){
        // return  JSON.parse(localStorage.getItems(USER_KEY)|| '{}')
        return store.get(USER_KEY)|| {}
    },
    removeUser(){
        // localStorage.removeItem(USER_KEY)
        store.remove(USER_KEY)
    }
}

```


















## antd model内的form中的输入框defaultValue不更新
解决方法为为每个dafaultvalue更换不同的key
