---
layout: post
title: react实战
categories: study
tags : Javascript
toc: true

---
# question
setState频繁使用，无限循环
## 按需引入

- 安装依赖

```Shell
yarn add craco craco-less babel-plugin-import
```

- 复制代码 因为antd是用less写的所以需要craco-less这个包来编译less文件 详细配置 修改启动脚本package.json

```json



"scripts": {
"start": "craco start",
"build": "craco build",
"test": "craco test"
}.
```

创建文件craco.config.js

```js


const CracoLessPlugin = require('craco-less')

module.exports = {
    plugins: [
        {
// 使用CracoLessPlugin自定义主题颜色
            plugin: CracoLessPlugin,
            options: {
                lessLoaderOptions: {
                    lessOptions: {
// 自定义less变量
                        modifyVars: {
                            '@primary-color': '#282c34', // 蓝黑色
                            '@success-color': '#5ecdc4', // 湖绿色
                            '@warning-color': '#6d4cc2', // 紫色
                            '@error-color': '#e64a19', // git桔色
                        },
                        javascriptEnabled: true, // 允许使用js修改less文件，必须为true，否则无法生效
                    },
                },
            },
        },
    ],
// 配置babel-plugin-import按需引用
    babel: {
        plugins: [
            [
                'import',
                {
                    libraryName: 'antd',
                    libraryDirectory: 'es',
                    style: true,
                },
            ],
        ],
    },
}
```

修改 src/App.jsx 添加`import './App.less' import { Row, Col, PageHeader, Card, Avatar, Button, Radio } from 'antd'`

`import './App.less' `创建less文件 src/App.less 
`@import '~antd/dist/antd.less';`



## form 表单的验证

### 声明式表单验证，自定义表单验证分别验证
username采用的是分别验证
passward采用的是函数validator验证
```js
import './login.less'
import logo from './images/logo.jpg'
import { Form, Input, Button, Checkbox } from 'antd';
import { UserOutlined, LockOutlined } from '@ant-design/icons';

export default function Login(){
    function onFinish(values){
        console.log('Received values of form: ', values);
    }
    function validatePwd(rules,value){
        if(!value){
            // callback("密码必须输入")
            return Promise.reject("密码必须输入")
        }else if(value.length<4){
            // callback("密码必须大于四位")
            return Promise.reject("密码必须大于四位")
        }else if(value.length>12){
            // callback('密码必须小于12位')
            return Promise.reject("密码必须小于12位")
        }else if(!(/^[a-zA-Z0-9]+$/.test(value))){
            // callback("只能包括字母数字以及下划线")
            return Promise.reject("只能包括字母数字以及下划线")
        }
        return  Promise.resolve();
    }
    return (
        <div className="login">
            <header className="loginHeader">
                <img src={logo} alt="logo"/>
                <h1>React项目 后台管理平台</h1>
            </header>
            <section className="loginSection">
                <h2>用户登录</h2>
                <Form
                    name="normal_login"
                    className="loginForm"
                    initialValues={{ remember: true }}
                    onFinish={onFinish}
                >
                    <Form.Item
                        name="username"
                        rules={[
                            { required: true, message: '请输入用户名' },
                            { min: 4, message: '至少输入4位' },
                            { max: 12, message: '最多12位' },
                            { pattern: /^[a-zA-Z0-9]+$/, message: '只能包括字母数字以及下划线' },
                        ]}
                    >
                        <Input prefix={<UserOutlined className="site-form-item-icon" />} placeholder="用户名" />
                    </Form.Item>
                    <Form.Item
                        name="password"
                        rules={[
                            { required: true, whitespace:true,message: '输入密码' },
                            // { min: 4, message: '至少输入4位' },
                            // { max: 12, message: '最多12位' },
                            // { pattern: /^[a-zA-Z0-9]+$/, message: '只能包括字母数字以及下划线' },
                            {validator:validatePwd}
                        ]}
                    >
                        <Input
                            prefix={<LockOutlined className="site-form-item-icon" />}
                            type="password"
                            placeholder="密码"
                        />
                    </Form.Item>
                    <Form.Item>
                        <Button className="loginFormButton" type="primary" htmlType="submit" >
                            登陆
                        </Button>
                    </Form.Item>
                </Form>
            </section>
        </div>
    )
}


```
### 点击提交时候统一验证
通常用于发送ajax请求后端验证

绑定表单使用`const[form]=useForm();`
表单里`from={form}`
form.function调取相应的实例方法`from.validateFields().then(()=>{})·
或者使用ref
`const f1=useRef();`
表单中`ref={f1}`
`f1.current.validateFields().then(()=>{})`
```js
import './login.less'
import logo from './images/logo.jpg'
import { Form, Input, Button, Checkbox } from 'antd';
import { UserOutlined, LockOutlined } from '@ant-design/icons';

import {useRef} from 'react'

export default function Login(){
    const [form] = Form.useForm();
    const f1=useRef("loginForm")
    console.log("formFrom",form)

    console.log("useref",f1)
    // f1.loginFrom.

    // f1.validateFields
    function onFinish(values){

        console.log('Received values of form: ', values);
        f1.current.validateFields().then((values)=>{
            console.log("validateFields",values)
        })

    }
    function validatePwd(rules,value){
        // console.log("validatePwd",rules,value)
        if(!value){
            // callback("")
            return Promise.reject("密码必须输入")
        }else if(value.length<4){
            // callback("密码必须大于四位")
            return Promise.reject("密码必须大于四位")
        }else if(value.length>12){
            // callback('密码必须小于12位')
            return Promise.reject("密码必须小于12位")
        }else if(!(/^[a-zA-Z0-9]+$/.test(value))){
            // callback("只能包括字母数字以及下划线")
            return Promise.reject("只能包括字母数字以及下划线")

        }
        return  Promise.resolve();
    }
    function onFinishFailed(){
        console.log("onfinishfailed")
    }

    return (
        <div className="login">
            <header className="loginHeader">
                <img src={logo} alt="logo"/>
                <h1>React项目 后台管理平台</h1>
            </header>
            <section className="loginSection">
                <h2>用户登录</h2>
                <Form
                    name="normal_login"
                    className="loginForm"
                    initialValues={{ remember: true }}
                    onFinish={onFinish}
                    form={form}
                    ref={f1}
 
                >
                    <Form.Item
                        name="username"
                        // rules={[
                        //     { required: true, message: '请输入用户名' },
                        //     { min: 4, message: '至少输入4位' },
                        //     { max: 12, message: '最多12位' },
                        //     { pattern: /^[a-zA-Z0-9]+$/, message: '只能包括字母数字以及下划线' },
                        //
                        //
                        // ]}
                    >
                        <Input prefix={<UserOutlined className="site-form-item-icon" />} placeholder="用户名" />
                    </Form.Item>
                    <Form.Item
                        name="password"
                        rules={[
                            { required: true, whitespace:true,message: '输入密码' },
                        ]}
                    >
                        <Input
                            prefix={<LockOutlined className="site-form-item-icon" />}
                            type="password"
                            placeholder="密码"
                        />
                    </Form.Item>
                    <Form.Item>
                        <Button className="loginFormButton" type="primary" htmlType="submit" >
                            登陆
                        </Button>
                    </Form.Item>
                </Form>
            </section>
        </div>
    )
}
```
## 发送请求
npm install axios
```js
import axios from 'axios'
import {message} from 'antd'
export default function ajax(url,data={},type="GET"){
    return new Promise((resolve,reject)=>{
        let promise;
        if(type==="GET"){
            promise=axios.get(url,
                {params: data})
        }else if(type==="POST"){
            promise=axios.post(url,data
            )
        }
        promise.then(response=>{
            message.success("ajax请求成功"+response.data)
            resolve(response.data)
        }).catch(error=>{
            message.error("ajax请求失败"+error.message)
        })
    })

}
```
```js
'
const base=""//"lovalhost:5000"
//根据接口文档写接口请求函数
export function reqLogin(username,password){
    return ajax(base+"/login",{username,password},"POST")//.then()

}
```

```js
 function onFinish(values){
        form.validateFields()
            .then( async (values) => {
                    const result =await reqLogin(values.username,values.password)
                    if(result.status){
                        message.error("登陆失败"+result.message)
                    }else{
                        message.success("登录成功"+result.message)
                        memoryUtils.user=result.data
                        storageUtils.saveUser(memoryUtils.user)
                        message.info("user保持成功",memoryUtils.user)
                    }
                    navigate('/admin')
            })
            .catch(errorInfo => {
                console.log("校验失败",errorInfo)
            });
        // navigate('/admin')
    }

```
## 用户变量本地存储

引入`store.js`库
npm install store
```js
import store from 'store'
const USER_KEY="user_key"
export default {
    saveUser(user){
        // alert("localstorage"+JSON.stringify(users))
        // localStorage.setItem(USER_KEY,JSON.stringify(users))
        store.set(USER_KEY,user)
    },
    getUser(){
        // return  JSON.parse(localStorage.getItems(USER_KEY)|| '{}')
        return store.get(USER_KEY)|| {}
    },
    removeUser(){
        // localStorage.removeItem(USER_KEY)
        store.remove(USER_KEY)
    }
}

```
### 子向父传值
父定义一个带形参的函数传递给子
父
```js
function getName=(name){
    console.log(name)
}
<Son getName={getName}>
```
子
```js
export default function Son(props){
    props.getName("tom")
    return(<div>
    son...
    </div>)
}

```
### 调用属性里面的值需要加[]

```js
    const my="opopop"
    const op={my:123,[my]:456}
    console.log(op)//Object {my: 123,opopop: 456}
```



## flask图片操作

### 返回图片
```python
@app.route('/manage/img/getimg',methods=["POST"])
def getImg():
    data=request.get_json()
    # print("getImg",data)
    # imgPath = r"D:\\Files\\Files\\images\\"+data['imgName']
    imgPathsList = []
    for root, dirs, files in os.walk(imgPaths):
        for f in files:
            imgPathsList.append(os.path.join(root,f))
    imgStream=""
    imgStreamList=[]
    # print(imgPathsList)
    for f in imgPathsList:  
        with open(f, 'rb') as img_f:

            imgStream = img_f.read()
            imgStream = base64.b64encode(imgStream)
            imgStreamList.append(imgStream)
    return jsonify({"imgDatas": imgStreamList})

```


前端接受
```js



```

### 链接访问图片

`localhost:5000/manage/photo/<imageID>.png`
```python
@app.route("/manage/photo/<imageID>.png")
def getImg2(imageID):
    with open(os.path.join(imgPaths,imageID+'.jpg'),'rb') as f:
        i=f.read()
        resu=Response(i,mimetype="image/jpg")
        return resu

```
### flask接受上传图片
```python
@app.route("/manage/img/upload",methods=["POSt"])
def uploadImg():
    try:
        img=request.files.get('image')
        # f = request.files["file"]
        print(img)
        n=str(ObjectId())
        img.save(os.path.join(imgPaths,n+".jpg"))
        print("upload Images",request.files)
        return jsonify({
        'status':0,
        'url':n+'.jpg'
    })
    except error:
        print(error)
        return jsonify({
        'status':1,

    })


```
## antd v4 Form表单的初始值设置
`Form`的`initialValues`值为一个`{"name":"oppo","Cascader":["手机","oppo"]}`
或者
`Form.Item`中的`initialValue='oppo'`设置子元素默认值，如果与 Form 的 initialValues 冲突则以 Form 为准
在设置form组件的initialValues是从接口中返回的数据，通过useState设置后无效。经过检查文档发现initialValues的值不能通过state改变。

```js
const [form] = useForm();
form.setFieldsValue(initialvalues)

```


## 富文本编辑器
```shell
npm install react-draft-wysiwyg,draftjs,draftjs-to-html


```

```js

import React  from 'react';
import { EditorState, convertToRaw } from 'draft-js';
import { Editor } from 'react-draft-wysiwyg';
import draftToHtml from 'draftjs-to-html';
import '../../../node_modules/react-draft-wysiwyg/dist/react-draft-wysiwyg.css';


import htmlToDraft from 'html-to-draftjs';

export default function RichTextEditot(){
  
    
    const [editorState,setEditorState]=React.useState(EditorState.createEmpty())
    const onEditorStateChange= (editorState) => {

          setEditorState(editorState)
      }
    const getDetail=()=>{
        return draftToHtml(convertToRaw(editorState.getCurrentContent()))
    }
    return (
        <div>
            <Editor
                editorState={editorState}
                wrapperClassName="demo-wrapper"
                editorClassName="demo-editor"
                onEditorStateChange={onEditorStateChange}
            />
            <textarea
                disabled
                value={draftToHtml(convertToRaw(editorState.getCurrentContent()))}
            />
        </div>       
    )
} 




```

```js
<span className="left">商品详情:</span>
<span dangerouslySetInnerHTML={{ __html: productDetail.detail }}></span>
```
## 父组件调用子组件的ref获取值

有的函数获取不到

父组件
```js
const richEdit=React.useRef(null)


<RichTextEditot  ref={richEdit}/>
```
子组件

```js
import React  from 'react';
import { EditorState, convertToRaw } from 'draft-js';
import { Editor } from 'react-draft-wysiwyg';
import draftToHtml from 'draftjs-to-html';
import '../../../node_modules/react-draft-wysiwyg/dist/react-draft-wysiwyg.css';


import htmlToDraft from 'html-to-draftjs';

// export default 
function RichTextEditot(props,richEdit){
    console.log('RichTextEditot(props)',props,richEdit)
    const [editorState,setEditorState]=React.useState(EditorState.createEmpty())
    const onEditorStateChange= (editorState) => {
        setEditorState(editorState)
    }
    return (
        <div ref={richEdit}>
            <Editor    
                editorState={editorState}
                wrapperClassName="demo-wrapper"
                editorClassName="demo-editor"
                editorStyle={{
                    border: "1px solid black",
                    minHeight: 200,
                    paddingLeft: 10,
                  }}
                
                onEditorStateChange={onEditorStateChange}
            />
            <textarea
                disabled
                style={{
                    border: "1px solid black",
                    minHeight: 200,
                    paddingLeft: 10,
                    width:'100%'
                  }}
                value={draftToHtml(convertToRaw(editorState.getCurrentContent()))}
            />
        </div>
    )
} 
export default React.forwardRef(RichTextEditot)

```

简化

```js
export default React.forwardRef((props,refse)=>{
    return(
        <div ref={refse}>
        </div>
    )
})


```