---
title: 文件系统
categories: study
tags : 操作系统复习
toc: true
---

> 文件的按名访问 
> 文件的存贮
# 文件
## 文件命名
- 文件命名向用户提供文件访问的抽象机制
文件是一个抽象机制，它提供了一种把信息保存在磁盘上而且便于以后读取的方法。文件系统必须使用户在访问文件时，不必了解信息存储的方法、位置及磁盘实际动作方式等细节。命名方法是抽象机制最重要的特征。在创建一个文件时，进程给出文件名。进程终止后，文件仍然存在，其他进程使用该文件名可以对它进行存取
- 文件的命名规则
- 文件扩展名
文件扩展名的作用有两种，一种扩展名不给计算机传送特别信息，只是用于表示这个文件的类型，给用户一 个提示信息。另一种扩展名，如C程序的扩展名，则为编译器、链接程序和系统提供信息,使它们能够区分哪些是C文件，哪些是汇编文件，哪些是其它文件。
## 文件结构
1)无结构字节序列 txt
(2)固定长度记录序列
     这个模型中，文件是一个固定长度记录的序列，每条记录都有内部结构，把文件作为记录序列的中心思想是：读操作返回一条记录，而写操作重写或追加一条记录。
## 文件类型
OS设计要考虑：系统应该支持哪些类型的文件，并为每种类型的文件定义合法的操作。文件的类型有：
- 正规文件
- 目录文件
- 字符设备文件
- 块设备文件等
ASCII文件
二进制文件
## 文件存取
  文件存取的方式有两种：
顺序存取：进程可以从文件开始处读取文件中的所有字节或者记录，但不能跳过某些内容   
随机存取：可以以任意顺序读取文件中的字节或记录
## 文件属性
文件属性是用来描述文件的信息，如文件长度、文件的创建日期，不同的系统为文件定义不同的属性
## 文件操作
下面是一些常用的系统调用，通过这些系统调用，可以实现对文件的存储和检索。
- (1)CREATE   创建文件，并设置文件属性。
- (2)DELETE   删除文件释放磁盘空间。
- (3)OPEN     使用文件之前，进程必须打开文件。OPEN调用的目的是：将文件属性和磁盘地址表载入主存，便于以后系统调用的快速存取。
- (4)CLOSE  当存取结束后，文件属性和磁盘地址就不再需要了，这时应该关闭文件，以释放内部表空间，许多系统限制进程打开的文件数，鼓励用户关闭不再使用的文件。 
- (5)READ   文件读取数据，应该指明读取的字节数及读入数据存放的缓冲区。
- (6)WRITE  写文件尾，则文件长度增加；写中间，则文件原数据丢失。
- (7)APPEND 只能在文件尾添加数据。
- (8)SEEK    对于随机存取文件，SEEK用于将文件指针指向特定位置。
- (9)GETATTRIBUTES
- (10)SETATTRIBUTES
- (11)RENAME
# 目录
## 层次目录结构
目录文件的结构

- ①属性和地址信息放在目录项中
-  ②属性和地址信息放在i节点中
   目录通常包含有许多目录项，每个目录项对应一个文件。在第①种结构中，每个目录项包含文件名、文件属性和文件数据在磁盘上的地址。在第②种结构中，目录项中会有一个文件名和一个i节点号，文件属性和磁盘地址就放在i节点中
   使用逻辑地址
   目录结构
      ①单层目录
      ②两级目录(一个用户一个目录)
      ③树型目录
      用户需要的是目录树，使每个用户可以拥有所需要的多个目录，以便自然地组织他们的文件
## 路径名
- (1)绝对路径名
    它由从根目录到文件的路径组成，绝对路径名总是从根目录开始，并且是唯一的。
- (2)相对路径名
     所有的路径名，如果不是从根目录开始的，都是相对 于当前目录(工作目录)的，同一文件的相对路径可能有多个，由当前工作目录而定。
## 目录操作
相对于文件的系统调用而言，各个系统中用于管理目录的系统调用差别更大，我们以unix系统为例，说明对系统目录有哪些操作。
1. CREATE 
2. DELETE
3. OPENDIR  
4. CLOSEDIR 
5. READDIR 
6. RENAME
# 实现文件系统
## 连续分配
连续分配是将文件作为连续数据块存储在磁盘上。
以磁盘块，簇为单位
- 优点：简单易实现，记录每个文件用到的磁盘块仅需一个数字，即第一块的磁盘地址。性能好，一次操作，可读出整个文件。
- 缺点：无法知道该为文件分多少空间，文件长度是会变的，造成磁盘碎片。
## 链式分配
为每个文件构造磁盘块的链接，每个块的第一个字用于指向下一块的指针，块的其它部分存放数据。在目录项中只需存放第一块的磁盘地址，文件的其它块可以根据这个地址来查找。
- 优点：磁盘空间利用率高，管理简单。
- 缺点：随机存取的速度慢
## 使用索引的链接表分配
使用方法二（链式分配）实现文件，取出每个磁盘块的地址信息（如：簇），把它放在内存的表或索引中。随机查找时，顺着链查找磁盘块，但只需查找内存中的链表，不需访问磁盘。
同以前的方法一样，不管文件有多大，在目录项中只需记录一个整数，根据它可以找到文件的所有块。MS-DOS就使用这种方法进行磁盘分配。

### 目录结合FAT表
目录项
|  A|  2|
|:-----|:-----|
链接表
|1|  |
|:-----|:-----|
| 2|10 |
|10|0  |
## CP/M中目录
只有一层目录，因此只有一个目录(文件)，查找文件名，就是在这个唯一的目录中找到文件对应的目录项，从目录项中获得文件存放的磁盘地址的目录
|用户码|文件名|扩展名 |范围|块数|磁盘块号|磁盘块号|...|
|--|--|--|--|--|--|--|--|
## MS—DOS中的目录
每个目录项包含文件名、文件属性、和 第一个磁盘块号，根据第一个磁盘块的块号，可以找到所有的文件块。MS-DOS是树型目录(层次型目录)
|文件名|扩展名 |属性|保留|时间|日期|第一块号|长度|
|--|--|--|--|--|--|--|--|--|--|
![在这里插入图片描述](https://img-blog.csdnimg.cn/20200611161025691.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MzQxOTE0,size_16,color_FFFFFF,t_70)
FAT2是FAT1的备份
FAT12采用12位文件分配表，磁盘块大小为2KB，
则FAT12可以管理的磁盘容量是8M。
  2KB×4K=8MB
FAT12文件系统文件名：只能是8.3格式的文件名。
说明：文件系统以簇（磁盘块）为单位为文件分配存储空间
## UNIX中的目录
UNIX中使用的目录结构非常简单，每个目录项只包
   含一个文件名及其i节点号。有关文件类型、长度、时间、
   拥有者和地址等所有信息都放在i-节点中 。当查找文
      件时先找到该文件的i节点存放的位置，再从i节点中找
      到该文件的磁盘块号。 
|文件名|i节点号  |
|--|--|
指针字段存下一个文件数据块的磁盘块号.fat索引表的实例:文件目录项指出文件A的第一个数据块在数据区的第四个磁盘块,fat表的第四个表项中存下一个数据块的磁盘块号7,fat表的第7项存下一个磁盘块号……
### i节点
给每个文件赋予一张称为i节点的小型表其中列出了文件属性和各数据块在磁盘上的地址，对于大文件，由于包含的磁盘块数很多，可以在i节点中存放一次间接地址，或二次间接地址，或三次间接地址。UNIX中使用这种分配方案![在这里插入图片描述](https://img-blog.csdnimg.cn/20200611162118123.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1MzQxOTE0,size_16,color_FFFFFF,t_70)
# 磁盘空间管理
文件通常存放在磁盘上，所以空间的管理是系统设计者要考虑的一个主要问题。
      文件的存放有两个策略：连续存放和***不连续***地分块存 放。连续存放存在一个缺陷，当文件扩大时，可能需要移动文件，而在磁盘上移动文件是很慢的。所以几乎所有的文件系统都把文件分割成固定大小的块来存储。各块不必相邻。 

## 块大小
   给文件分配块太大，浪费磁盘空间。
   块太小，查找一个文件多次寻道,浪费时间。
   一般选择的块大小在512字，1KB或2KB。若扇区大小为512个字节，磁盘块的大小选定为1KB，则文件系统读写两个连续的扇区，并把它们看成不可分割的单元。 
   现在的磁盘扇区大小有的是1KB，不一定是512字节。
## 记录空闲块
- ①空白磁盘块的**链接表**
   用一些空白磁盘块存放空闲磁盘块块号。一个磁盘块存放尽可能多的空闲盘块号，并专门留出最后几个字节存放指向下一个存放空闲盘块号的磁盘块的指针 。

-   ②用n位**位图**表示磁盘块使用情况
 磁盘被划分成n块，用n位位图表示磁盘块使用情况,
每一位代表一个盘块，比如用：位的值为0表示磁盘空闲，位的值为1表示磁盘已分配

| 0 |1|1|0|1|
|--|--|--|--|--
| 0号磁盘块|1号磁盘块|...|

当内存只分配一块大小存放磁盘使用信息时，使用链表比使用位图好。因为一个磁盘块中存放的位图，可能没有一个空白磁盘块可供使用，还得再从磁盘中调入下一块位图。

## 虚拟文件系统(VFS)
虚拟文件系统（Virtual Filesystem）也可以称之为虚拟文件系统转换（Virtual Filesystem Switch）或VFS，是一个内核软件层，用来处理与Unix标准文件系统相关的所有系统调用,能为各种文件系统提供一个通用的接口

```cpp
       索引节点表(一个文件一个)
       struct ext2_inode
     {
         _le16   i_mode	    文件类型和访问权限
         _le16   i_uid       拥有者标识符
         _le16   i_size	       以字节为单位的文件长度 
         _le32   i_blocks	       文件的数据块数 
         _le32 [EXT2_N_BLOCKS] 	i_block指向数据块的指针
    ……
   }
目录(一个文件对应一个目录项条目)
      struct ext2_dir_entry_2
     {
     _le32	inode	          索引节点号
     _le16	rec_len          目录项长度
     _u8 	name_len        文件名长度
     _u8 	file_type            文件类型
     char [EXT2_NAME_LEN]  name文件名
     }

```

